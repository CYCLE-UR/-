<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½æ¶ç¥¨åŠ©æ‰‹ - v0.8 å®Œæ•´æ¼”ç¤º</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.x/gun.js"></script>
  
  <script type="module">
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue

    // å°å…¥æ‰€æœ‰æ¨¡å¡Š
    const modules = await Promise.all([
      import('./js/storage.js'),
      import('./js/bot-engine.js'),
      import('./js/automation-engine.js'),
      import('./js/notifications.js'),
      import('./js/task-model.js'),
      import('./js/import-export.js'),
      import('./js/batch-operations.js'),
      import('./js/advanced-search.js'),
      import('./js/permissions.js'),
      import('./js/cache-manager.js'),
      import('./js/performance-optimization.js'),
      import('./js/skeleton-loader.js')
    ])

    const { initGUN, loginAnonymous, getCurrentUser, logout } = modules[0]
    const { createBotEngine } = modules[1]
    const { createAutomationEngine } = modules[2]
    const { createNotificationSystem } = modules[3]
    const { createDefaultTask } = modules[4]
    const { exportTasksAsJSON, exportTasksAsCSV, importTasksFromJSON, importTasksFromCSV, importTasksFromFile } = modules[5]
    const { batchStartTasks, batchPauseTasks, batchDeleteTasks, filterTasks, sortTasks } = modules[6]
    const { advancedSearch, complexSearch, advancedSort, groupTasks, statisticsTasks } = modules[7]
    const { createPermissionManager } = modules[8]
    const { createCacheManager } = modules[9]
    const { debounce, throttle, memoize } = modules[10]
    const { createSkeletonManager, withSkeleton } = modules[11]

    // å‰µå»ºå¼•æ“å’Œç³»çµ±
    const botEngine = createBotEngine()
    const automationEngine = createAutomationEngine()
    const notificationSystem = createNotificationSystem()
    const permissionManager = createPermissionManager('user')
    const cacheManager = createCacheManager(60000) // 60ç§’TTL
    const skeletonManager = createSkeletonManager()

    // å‰µå»º Vue æ‡‰ç”¨
    const app = createApp({
      template: `
        <div class="min-h-screen bg-gray-50">
          <!-- å°èˆªæ¬„ -->
          <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <div class="text-3xl">ğŸ«</div>
                  <div>
                    <h1 class="text-xl font-bold text-gray-800">æ™ºèƒ½æ¶ç¥¨åŠ©æ‰‹</h1>
                    <p class="text-xs text-gray-500">v0.8 - Stage 6 å®Œæ•´æ¼”ç¤º</p>
                  </div>
                </div>
                <div class="flex items-center gap-4" v-if="loggedIn">
                  <div class="hidden md:flex gap-4 text-sm">
                    <div><span class="font-bold text-indigo-600">{{ stats.total }}</span> ä»»å‹™</div>
                    <div><span class="font-bold text-green-600">{{ stats.success }}</span> æˆåŠŸ</div>
                    <div><span class="font-bold text-red-600">{{ stats.failed }}</span> å¤±æ•—</div>
                  </div>
                  <button @click="handleLogout" class="btn-secondary text-sm">ç™»å‡º</button>
                </div>
              </div>
            </div>
          </nav>

          <!-- ä¸»å…§å®¹ -->
          <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- é€šçŸ¥ -->
            <div v-if="notification.show" 
                 :class="['fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in',
                          notification.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700']">
              <div class="flex justify-between items-start">
                <p>{{ notification.message }}</p>
                <button @click="notification.show = false" class="ml-4 text-lg">&times;</button>
              </div>
            </div>

            <!-- æœªç™»éŒ„ -->
            <div v-if="!loggedIn" class="card text-center py-16">
              <div class="text-8xl mb-6">ğŸ«</div>
              <h2 class="text-3xl font-bold text-gray-800 mb-3">æ­¡è¿ä½¿ç”¨æ™ºèƒ½æ¶ç¥¨åŠ©æ‰‹</h2>
              <p class="text-gray-600 mb-8">è‡ªå‹•åŒ–æ¶ç¥¨ Â· å¯¦æ™‚é€šçŸ¥ Â· å¤šè¨­å‚™åŒæ­¥</p>
              <button @click="handleLogin" class="btn-primary text-lg px-8 py-3">
                ğŸš€ é–‹å§‹ä½¿ç”¨
              </button>
            </div>

            <!-- å·²ç™»éŒ„ -->
            <div v-if="loggedIn" class="space-y-6">
              <!-- æ¨™ç±¤å°èˆª -->
              <div class="bg-white rounded-lg shadow-sm p-1 inline-flex gap-1 flex-wrap">
                <button 
                  v-for="tab in tabs" :key="tab"
                  @click="activeTab = tab"
                  :class="['px-4 py-2 rounded-md text-sm font-medium transition',
                           activeTab === tab ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100']">
                  {{ tab }}
                </button>
              </div>

              <!-- ä»»å‹™åˆ—è¡¨ (å«æœå°‹å’Œæ‰¹é‡æ“ä½œ) -->
              <div v-if="activeTab === 'ä»»å‹™åˆ—è¡¨'">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                  <h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„ä»»å‹™</h2>
                  <div class="flex gap-2">
                    <button @click="showForm = true" class="btn-primary">â• æ–°å¢ä»»å‹™</button>
                    <button @click="showImportDialog = true" class="btn-secondary">ğŸ“¥ å°å…¥</button>
                    <button @click="exportCurrentTasks" class="btn-secondary">ğŸ“¤ å°å‡º</button>
                  </div>
                </div>

                <!-- æœå°‹å’Œéæ¿¾ -->
                <div class="card mb-4 space-y-3">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input 
                      v-model="searchQuery"
                      @input="performSearch"
                      type="text" 
                      placeholder="ğŸ” æœå°‹ä»»å‹™åç¨±..."
                      class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <select v-model="filterStatus" 
                            @change="applyFilters"
                            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                      <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                      <option value="pending">å¾…æ©Ÿ</option>
                      <option value="running">é‹è¡Œä¸­</option>
                      <option value="success">æˆåŠŸ</option>
                      <option value="failed">å¤±æ•—</option>
                      <option value="paused">å·²æš«åœ</option>
                    </select>

                    <select v-model="sortBy" 
                            @change="applySort"
                            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                      <option value="createdAt">æœ€æ–°å»ºç«‹</option>
                      <option value="priority">å„ªå…ˆç´š</option>
                      <option value="eventDate">æ´»å‹•æ—¥æœŸ</option>
                    </select>
                  </div>

                  <!-- æ‰¹é‡æ“ä½œ -->
                  <div v-if="selectedTasks.length > 0" class="bg-indigo-50 p-3 rounded-lg flex items-center justify-between flex-wrap gap-2">
                    <span class="text-sm font-semibold text-indigo-700">å·²é¸æ“‡ {{ selectedTasks.length }} å€‹ä»»å‹™</span>
                    <div class="flex gap-2">
                      <button @click="batchStart" class="btn-sm bg-green-600 text-white hover:bg-green-700">
                        â–¶ æ‰¹é‡é–‹å§‹
                      </button>
                      <button @click="batchPause" class="btn-sm bg-yellow-600 text-white hover:bg-yellow-700">
                        â¸ æ‰¹é‡æš«åœ
                      </button>
                      <button @click="batchDelete" class="btn-sm bg-red-600 text-white hover:bg-red-700">
                        ğŸ—‘ æ‰¹é‡åˆªé™¤
                      </button>
                      <button @click="clearSelection" class="btn-sm bg-gray-600 text-white hover:bg-gray-700">
                        âœ• å–æ¶ˆé¸æ“‡
                      </button>
                    </div>
                  </div>
                </div>

                <!-- ä»»å‹™é¡¯ç¤º -->
                <div v-if="displayedTasks.length === 0" class="card text-center py-12">
                  <div class="text-6xl mb-4">ğŸ“</div>
                  <h3 class="text-xl font-bold text-gray-800 mb-2">æš«ç„¡ä»»å‹™</h3>
                  <p class="text-gray-600 mb-4">é–‹å§‹å‰µå»ºæ‚¨çš„ç¬¬ä¸€å€‹æ¶ç¥¨ä»»å‹™</p>
                  <button @click="showForm = true" class="btn-primary">å‰µå»ºä»»å‹™</button>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div v-for="task in displayedTasks" :key="task.id"
                       class="card hover:shadow-lg transition">
                    <div class="flex gap-3 mb-3">
                      <input 
                        v-model="selectedTasks"
                        :value="task.id"
                        type="checkbox"
                        class="w-5 h-5 rounded cursor-pointer">
                      <div class="flex-1">
                        <h3 class="font-bold text-gray-800">{{ task.eventName }}</h3>
                        <p class="text-sm text-gray-500">{{ task.name }}</p>
                      </div>
                      <span :class="['status-badge', statusClass(task.status)]">
                        {{ statusText(task.status) }}
                      </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                      <div>ğŸ“… {{ task.eventDate }}</div>
                      <div>â° {{ task.startTime }}</div>
                      <div>ğŸ« {{ task.ticketQuantity }} å¼µ</div>
                      <div>â­ {{ task.priority }}/10 å„ªå…ˆç´š</div>
                    </div>
                    <div class="flex gap-2 pt-3 border-t flex-wrap">
                      <button v-if="task.status === 'pending'" 
                              @click="startTask(task.id)"
                              class="btn-sm bg-green-600 text-white hover:bg-green-700 flex-1">
                        â–¶ é–‹å§‹
                      </button>
                      <button v-if="task.status === 'running'" 
                              @click="pauseTask(task.id)"
                              class="btn-sm bg-yellow-600 text-white hover:bg-yellow-700 flex-1">
                        â¸ æš«åœ
                      </button>
                      <button @click="deleteTask(task.id)"
                              class="btn-sm bg-red-600 text-white hover:bg-red-700">
                        ğŸ—‘
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- çµ±è¨ˆ -->
              <div v-if="activeTab === 'çµ±è¨ˆ'">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">çµ±è¨ˆåˆ†æ</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <div class="text-3xl font-bold">{{ stats.total }}</div>
                    <div class="text-sm opacity-90">ç¸½ä»»å‹™æ•¸</div>
                  </div>
                  <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white">
                    <div class="text-3xl mb-2">âœ…</div>
                    <div class="text-3xl font-bold">{{ stats.success }}</div>
                    <div class="text-sm opacity-90">æˆåŠŸä»»å‹™</div>
                  </div>
                  <div class="card bg-gradient-to-br from-red-500 to-red-600 text-white">
                    <div class="text-3xl mb-2">âŒ</div>
                    <div class="text-3xl font-bold">{{ stats.failed }}</div>
                    <div class="text-sm opacity-90">å¤±æ•—ä»»å‹™</div>
                  </div>
                  <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                    <div class="text-3xl mb-2">ğŸ“ˆ</div>
                    <div class="text-3xl font-bold">{{ stats.rate }}%</div>
                    <div class="text-sm opacity-90">æˆåŠŸç‡</div>
                  </div>
                </div>

                <!-- ä»»å‹™åˆ†é¡çµ±è¨ˆ -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="card">
                    <h3 class="text-lg font-bold mb-4">ç‹€æ…‹åˆ†å¸ƒ</h3>
                    <div class="space-y-2">
                      <div class="flex justify-between items-center">
                        <span class="text-sm">å¾…æ©Ÿ</span>
                        <div class="flex-1 mx-3 h-2 bg-gray-200 rounded">
                          <div class="h-full bg-gray-500 rounded" :style="{width: stats.pendingPercent + '%'}"></div>
                        </div>
                        <span class="text-sm font-semibold">{{ stats.pending }}</span>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-sm">é‹è¡Œä¸­</span>
                        <div class="flex-1 mx-3 h-2 bg-gray-200 rounded">
                          <div class="h-full bg-blue-500 rounded" :style="{width: stats.runningPercent + '%'}"></div>
                        </div>
                        <span class="text-sm font-semibold">{{ stats.running }}</span>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-sm">æˆåŠŸ</span>
                        <div class="flex-1 mx-3 h-2 bg-gray-200 rounded">
                          <div class="h-full bg-green-500 rounded" :style="{width: stats.successPercent + '%'}"></div>
                        </div>
                        <span class="text-sm font-semibold">{{ stats.success }}</span>
                      </div>
                      <div class="flex justify-between items-center">
                        <span class="text-sm">å¤±æ•—</span>
                        <div class="flex-1 mx-3 h-2 bg-gray-200 rounded">
                          <div class="h-full bg-red-500 rounded" :style="{width: stats.failedPercent + '%'}"></div>
                        </div>
                        <span class="text-sm font-semibold">{{ stats.failed }}</span>
                      </div>
                    </div>
                  </div>
                  <div class="card">
                    <h3 class="text-lg font-bold mb-4">å„ªå…ˆç´šåˆ†å¸ƒ</h3>
                    <div class="space-y-3">
                      <div v-for="level in [1, 2, 3]" :key="level" class="flex items-center gap-3">
                        <span class="text-sm font-semibold">ç­‰ç´š {{ level * 3 }}-{{ (level + 1) * 3 }}</span>
                        <div class="flex-1 h-8 bg-gray-200 rounded flex items-center justify-center text-sm font-bold">
                          {{ countByPriority(level * 3, (level + 1) * 3) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- è¨­ç½® -->
              <div v-if="activeTab === 'è¨­ç½®'">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ç³»çµ±è¨­ç½®</h2>
                <div class="space-y-4">
                  <div class="card space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-3">é€šçŸ¥è¨­ç½®</h3>
                    <div class="flex justify-between items-center">
                      <div>
                        <p class="font-semibold">æ¡Œé¢é€šçŸ¥</p>
                        <p class="text-sm text-gray-600">å…è¨±é¡¯ç¤ºæ¡Œé¢é€šçŸ¥</p>
                      </div>
                      <button @click="requestNotifPermission"
                              class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        {{ notificationEnabled ? 'âœ“ å·²å•Ÿç”¨' : 'è«‹æ±‚æ¬Šé™' }}
                      </button>
                    </div>
                  </div>

                  <div class="card space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-3">æ•¸æ“šç®¡ç†</h3>
                    <div class="flex justify-between items-center">
                      <div>
                        <p class="font-semibold">å°å‡ºæ‰€æœ‰ä»»å‹™</p>
                        <p class="text-sm text-gray-600">å‚™ä»½æ‚¨çš„æ‰€æœ‰ä»»å‹™æ•¸æ“š</p>
                      </div>
                      <div class="flex gap-2">
                        <button @click="exportAsJSON" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                          JSON
                        </button>
                        <button @click="exportAsCSV" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                          CSV
                        </button>
                      </div>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t">
                      <div>
                        <p class="font-semibold">æ¸…é™¤æ‰€æœ‰æ•¸æ“š</p>
                        <p class="text-sm text-gray-600 text-red-600">æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·</p>
                      </div>
                      <button @click="clearAllData" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        æ¸…é™¤æ•¸æ“š
                      </button>
                    </div>
                  </div>

                  <div class="card bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3">ç³»çµ±ç‰ˆæœ¬</h3>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span>æ‡‰ç”¨ç‰ˆæœ¬ï¼š</span>
                        <span class="font-semibold">v0.8 - Stage 6</span>
                      </div>
                      <div class="flex justify-between">
                        <span>æ¸¬è©¦ç‹€æ…‹ï¼š</span>
                        <span class="font-semibold text-green-600">162/162 âœ“</span>
                      </div>
                      <div class="flex justify-between">
                        <span>æ ¸å¿ƒæ¨¡å¡Šï¼š</span>
                        <span class="font-semibold">8 (å«æ–°å¢ Stage 6 åŠŸèƒ½)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </main>

          <!-- ä»»å‹™è¡¨å–®å½ˆçª— -->
          <div v-if="showForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold">å‰µå»ºæ–°ä»»å‹™</h2>
                  <button @click="closeForm" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <form @submit.prevent="saveTask" class="space-y-4">
                  <div>
                    <label class="block text-sm font-semibold mb-1">ä»»å‹™åç¨±</label>
                    <input v-model="form.name" type="text" required
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                  </div>
                  <div>
                    <label class="block text-sm font-semibold mb-1">æ´»å‹•åç¨±</label>
                    <input v-model="form.eventName" type="text" required
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-semibold mb-1">æ´»å‹•æ—¥æœŸ</label>
                      <input v-model="form.eventDate" type="date" required
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                      <label class="block text-sm font-semibold mb-1">é–‹æ¶æ™‚é–“</label>
                      <input v-model="form.startTime" type="datetime-local" required
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-semibold mb-1">è³¼è²·æ•¸é‡</label>
                      <input v-model.number="form.ticketQuantity" type="number" min="1" max="10" required
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                      <label class="block text-sm font-semibold mb-1">å„ªå…ˆç´š (1-10)</label>
                      <input v-model.number="form.priority" type="number" min="1" max="10"
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold mb-1">ç›®æ¨™ç¶²å€</label>
                    <input v-model="form.targetUrl" type="url"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                           placeholder="https://ticketmaster.com/...">
                  </div>
                  <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">å‰µå»ºä»»å‹™</button>
                    <button type="button" @click="closeForm" class="btn-secondary flex-1">å–æ¶ˆ</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- å°å…¥å°è©±æ¡† -->
          <div v-if="showImportDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">å°å…¥ä»»å‹™</h2>
                <button @click="showImportDialog = false" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2">é¸æ“‡æ–‡ä»¶æ ¼å¼</label>
                  <select v-model="importFormat" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="json">JSON æ ¼å¼</option>
                    <option value="csv">CSV æ ¼å¼</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2">ä¸Šå‚³æ–‡ä»¶</label>
                  <input 
                    type="file"
                    :accept="importFormat === 'json' ? '.json' : '.csv'"
                    @change="handleFileImport"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>

                <div class="flex gap-3">
                  <button @click="confirmImport" class="btn-primary flex-1" v-if="importData">å°å…¥</button>
                  <button @click="showImportDialog = false" class="btn-secondary flex-1">å–æ¶ˆ</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `,

      setup() {
        const loading = ref(false)
        const loggedIn = ref(false)
        const activeTab = ref('ä»»å‹™åˆ—è¡¨')
        const showForm = ref(false)
        const showImportDialog = ref(false)
        const tasks = ref([])
        const displayedTasks = ref([])
        const selectedTasks = ref([])
        const searchQuery = ref('')
        const filterStatus = ref('')
        const sortBy = ref('createdAt')
        const importFormat = ref('json')
        const importData = ref(null)
        const notificationEnabled = ref(false)
        const notification = reactive({ show: false, type: 'success', message: '' })
        const form = reactive({
          name: '', eventName: '', eventDate: '', startTime: '',
          ticketQuantity: 1, priority: 5, targetUrl: '', clickSelector: '.buy-button'
        })

        const tabs = ['ä»»å‹™åˆ—è¡¨', 'çµ±è¨ˆ', 'è¨­ç½®']

        const stats = computed(() => {
          const total = tasks.value.length
          const pending = tasks.value.filter(t => t.status === 'pending').length
          const running = tasks.value.filter(t => t.status === 'running').length
          const success = tasks.value.filter(t => t.status === 'success').length
          const failed = tasks.value.filter(t => t.status === 'failed').length
          
          return { 
            total, 
            pending,
            running,
            success, 
            failed, 
            pendingPercent: total > 0 ? (pending / total) * 100 : 0,
            runningPercent: total > 0 ? (running / total) * 100 : 0,
            successPercent: total > 0 ? (success / total) * 100 : 0,
            failedPercent: total > 0 ? (failed / total) * 100 : 0,
            rate: total > 0 ? Math.round((success / total) * 100) : 0 
          }
        })

        const countByPriority = (min, max) => {
          return tasks.value.filter(t => t.priority >= min && t.priority <= max).length
        }

        const notify = (msg, type = 'success') => {
          notification.show = true
          notification.type = type
          notification.message = msg
          setTimeout(() => notification.show = false, 3000)
        }

        const closeForm = () => {
          showForm.value = false
          form.name = ''
          form.eventName = ''
          form.eventDate = ''
          form.startTime = ''
          form.ticketQuantity = 1
          form.priority = 5
          form.targetUrl = ''
          form.clickSelector = ''
        }

        const statusClass = (status) => {
          const map = {
            'pending': 'status-pending',
            'running': 'status-running',
            'success': 'status-success',
            'failed': 'status-failed',
            'paused': 'status-paused'
          }
          return map[status] || 'status-pending'
        }

        const statusText = (status) => {
          const map = {
            'pending': 'å¾…æ©Ÿ',
            'running': 'é‹è¡Œä¸­',
            'success': 'æˆåŠŸ',
            'failed': 'å¤±æ•—',
            'paused': 'å·²æš«åœ'
          }
          return map[status] || status
        }

        const loadTasks = async () => {
          tasks.value = await botEngine.listTasks()
          applyFilters()
        }

        const performSearch = debounce(async () => {
          if (!searchQuery.value.trim()) {
            applyFilters()
            return
          }
          
          const results = advancedSearch(tasks.value, searchQuery.value, {
            searchFields: ['name', 'eventName'],
            matchMode: 'contains',
            caseSensitive: false
          })
          displayedTasks.value = results
        }, 300)

        const applyFilters = () => {
          let filtered = tasks.value
          
          if (filterStatus.value) {
            filtered = filterTasks(tasks.value, { status: filterStatus.value })
          }
          
          displayedTasks.value = filtered
          applySort()
        }

        const applySort = () => {
          const sorted = advancedSort(displayedTasks.value, sortBy.value, 'desc')
          displayedTasks.value = sorted
        }

        const handleLogin = async () => {
          loading.value = true
          try {
            await loginAnonymous()
            loggedIn.value = true
            await loadTasks()
            notify('ç™»å…¥æˆåŠŸï¼')
          } catch (e) {
            notify(e.message, 'error')
          } finally {
            loading.value = false
          }
        }

        const handleLogout = async () => {
          await logout()
          loggedIn.value = false
          tasks.value = []
          displayedTasks.value = []
          notify('ç™»å‡ºæˆåŠŸ')
        }

        const saveTask = async () => {
          try {
            const task = createDefaultTask({
              name: form.name,
              eventName: form.eventName,
              eventDate: form.eventDate,
              startTime: form.startTime,
              ticketQuantity: form.ticketQuantity,
              priority: form.priority,
              config: {
                targetUrl: form.targetUrl,
                clickSelector: form.clickSelector,
                clickDelay: 500,
                retryCount: 3
              }
            })
            await botEngine.addTask(task)
            await loadTasks()
            closeForm()
            notify('ä»»å‹™å‰µå»ºæˆåŠŸï¼')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const startTask = async (id) => {
          try {
            await botEngine.startTask(id)
            await loadTasks()
            notify('ä»»å‹™å·²é–‹å§‹åŸ·è¡Œ')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const pauseTask = async (id) => {
          try {
            await botEngine.pauseTask(id)
            await loadTasks()
            notify('ä»»å‹™å·²æš«åœ')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const deleteTask = async (id) => {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ')) return
          try {
            await botEngine.deleteTask(id)
            await loadTasks()
            notify('ä»»å‹™å·²åˆªé™¤')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const batchStart = async () => {
          try {
            const startedCount = await batchStartTasks(botEngine, selectedTasks.value)
            await loadTasks()
            selectedTasks.value = []
            notify(`æˆåŠŸé–‹å§‹ ${startedCount} å€‹ä»»å‹™`)
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const batchPause = async () => {
          try {
            const pausedCount = await batchPauseTasks(botEngine, selectedTasks.value)
            await loadTasks()
            selectedTasks.value = []
            notify(`æˆåŠŸæš«åœ ${pausedCount} å€‹ä»»å‹™`)
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const batchDelete = async () => {
          if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedTasks.value.length} å€‹ä»»å‹™å—ï¼Ÿ`)) return
          try {
            const deletedCount = await batchDeleteTasks(botEngine, selectedTasks.value)
            await loadTasks()
            selectedTasks.value = []
            notify(`æˆåŠŸåˆªé™¤ ${deletedCount} å€‹ä»»å‹™`)
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const clearSelection = () => {
          selectedTasks.value = []
        }

        const exportAsJSON = async () => {
          try {
            const json = await exportTasksAsJSON(tasks.value)
            const blob = new Blob([json], { type: 'application/json' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `tasks-${new Date().toISOString().slice(0, 10)}.json`
            a.click()
            notify('ä»»å‹™å·²å°å‡ºç‚º JSON')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const exportAsCSV = async () => {
          try {
            const csv = await exportTasksAsCSV(tasks.value)
            const blob = new Blob([csv], { type: 'text/csv' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `tasks-${new Date().toISOString().slice(0, 10)}.csv`
            a.click()
            notify('ä»»å‹™å·²å°å‡ºç‚º CSV')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const exportCurrentTasks = () => {
          showImportDialog.value = true
          // æç¤ºé¸æ“‡æ ¼å¼
          notify('è«‹é¸æ“‡å°å‡ºæ ¼å¼')
        }

        const handleFileImport = async (e) => {
          const file = e.target.files?.[0]
          if (!file) return
          
          try {
            const text = await file.text()
            if (importFormat.value === 'json') {
              importData.value = JSON.parse(text)
            } else {
              importData.value = text
            }
            notify('æ–‡ä»¶å·²åŠ è¼‰ï¼Œé»æ“Šå°å…¥æŒ‰éˆ•ç¢ºèª')
          } catch (e) {
            notify('æ–‡ä»¶æ ¼å¼éŒ¯èª¤', 'error')
          }
        }

        const confirmImport = async () => {
          try {
            let importedTasks
            if (importFormat.value === 'json') {
              importedTasks = await importTasksFromJSON(importData.value)
            } else {
              importedTasks = await importTasksFromCSV(importData.value)
            }
            
            for (const task of importedTasks) {
              await botEngine.addTask(task)
            }
            
            await loadTasks()
            showImportDialog.value = false
            importData.value = null
            notify(`æˆåŠŸå°å…¥ ${importedTasks.length} å€‹ä»»å‹™`)
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const clearAllData = async () => {
          if (!confirm('æ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰ä»»å‹™ä¸”ç„¡æ³•æ’¤éŠ·ï¼Œç¢ºå®šå—ï¼Ÿ')) return
          try {
            for (const task of tasks.value) {
              await botEngine.deleteTask(task.id)
            }
            await loadTasks()
            notify('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const requestNotifPermission = async () => {
          try {
            const permission = await notificationSystem.requestPermission()
            if (permission === 'granted') {
              notificationEnabled.value = true
              notify('é€šçŸ¥æ¬Šé™å·²å•Ÿç”¨ï¼')
            } else {
              notify('é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•', 'error')
            }
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        onMounted(async () => {
          try {
            await initGUN()
            const user = getCurrentUser()
            if (user) {
              loggedIn.value = true
              await loadTasks()
            }
          } catch (e) {
            console.error(e)
          } finally {
            loading.value = false
          }
        })

        return {
          loading, loggedIn, activeTab, showForm, showImportDialog, tasks, displayedTasks, selectedTasks, 
          searchQuery, filterStatus, sortBy, importFormat, importData, notificationEnabled,
          notification, form, tabs, stats, countByPriority,
          handleLogin, handleLogout, saveTask, startTask, pauseTask, deleteTask,
          batchStart, batchPause, batchDelete, clearSelection,
          exportAsJSON, exportAsCSV, exportCurrentTasks, handleFileImport, confirmImport, clearAllData,
          closeForm, statusClass, statusText, requestNotifPermission, performSearch, applyFilters, applySort
        }
      }
    })

    app.mount('#app')
  </script>
</body>
</html>
