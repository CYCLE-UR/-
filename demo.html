<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½æ¶ç¥¨åŠ©æ‰‹ - å®Œæ•´æ¼”ç¤º</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-gray-50">
  <!-- Vue æ‡‰ç”¨æ ¹å…ƒç´  -->
  <div id="app"></div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <!-- GUN.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.x/gun.js"></script>
  
  <!-- æ‡‰ç”¨é‚è¼¯ -->
  <script type="module">
    const { createApp, ref, reactive, computed, onMounted } = Vue

    // å°å…¥æ¨¡å¡Š
    const modules = await Promise.all([
      import('./js/storage.js'),
      import('./js/bot-engine.js'),
      import('./js/automation-engine.js'),
      import('./js/notifications.js'),
      import('./js/task-model.js')
    ])

    const { initGUN, loginAnonymous, getCurrentUser, logout } = modules[0]
    const { createBotEngine } = modules[1]
    const { createAutomationEngine } = modules[2]
    const { createNotificationSystem } = modules[3]
    const { createDefaultTask } = modules[4]

    // å‰µå»ºå¼•æ“å¯¦ä¾‹
    const botEngine = createBotEngine()
    const automationEngine = createAutomationEngine()
    const notificationSystem = createNotificationSystem()

    // å‰µå»º Vue æ‡‰ç”¨
    const app = createApp({
      template: `
        <div class="min-h-screen bg-gray-50">
          <!-- å°èˆªæ¬„ -->
          <nav class="bg-white shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <div class="text-3xl">ğŸ«</div>
                  <div>
                    <h1 class="text-xl font-bold text-gray-800">æ™ºèƒ½æ¶ç¥¨åŠ©æ‰‹</h1>
                    <p class="text-xs text-gray-500">v0.4 - Stage 4 å®Œæ•´æ¼”ç¤º</p>
                  </div>
                </div>
                <div class="flex items-center gap-4" v-if="loggedIn">
                  <div class="hidden md:flex gap-4 text-sm">
                    <div><span class="font-bold text-indigo-600">{{ stats.total }}</span> ä»»å‹™</div>
                    <div><span class="font-bold text-green-600">{{ stats.success }}</span> æˆåŠŸ</div>
                    <div><span class="font-bold text-red-600">{{ stats.failed }}</span> å¤±æ•—</div>
                  </div>
                  <button @click="handleLogout" class="btn-secondary text-sm">ç™»å‡º</button>
                </div>
              </div>
            </div>
          </nav>

          <!-- ä¸»å…§å®¹ -->
          <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- åŠ è¼‰ç‹€æ…‹ -->
            <div v-if="loading" class="flex justify-center items-center py-20">
              <div class="spinner"></div>
              <p class="ml-4 text-gray-600">åŠ è¼‰ä¸­...</p>
            </div>

            <!-- é€šçŸ¥ -->
            <div v-if="notification.show" 
                 :class="['fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in',
                          notification.type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700']">
              <div class="flex justify-between items-start">
                <p>{{ notification.message }}</p>
                <button @click="notification.show = false" class="ml-4 text-lg">&times;</button>
              </div>
            </div>

            <!-- æœªç™»éŒ„ -->
            <div v-if="!loading && !loggedIn" class="card text-center py-16">
              <div class="text-8xl mb-6">ğŸ«</div>
              <h2 class="text-3xl font-bold text-gray-800 mb-3">æ­¡è¿ä½¿ç”¨æ™ºèƒ½æ¶ç¥¨åŠ©æ‰‹</h2>
              <p class="text-gray-600 mb-8">è‡ªå‹•åŒ–æ¶ç¥¨ Â· å¯¦æ™‚é€šçŸ¥ Â· å¤šè¨­å‚™åŒæ­¥</p>
              <button @click="handleLogin" class="btn-primary text-lg px-8 py-3">
                ğŸš€ é–‹å§‹ä½¿ç”¨
              </button>
            </div>

            <!-- å·²ç™»éŒ„ -->
            <div v-if="!loading && loggedIn" class="space-y-6">
              <!-- æ¨™ç±¤å°èˆª -->
              <div class="bg-white rounded-lg shadow-sm p-1 inline-flex gap-1">
                <button 
                  v-for="tab in tabs" :key="tab"
                  @click="activeTab = tab"
                  :class="['px-4 py-2 rounded-md text-sm font-medium transition',
                           activeTab === tab ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100']">
                  {{ tab }}
                </button>
              </div>

              <!-- ä»»å‹™åˆ—è¡¨ -->
              <div v-if="activeTab === 'ä»»å‹™åˆ—è¡¨'">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-2xl font-bold text-gray-800">æˆ‘çš„ä»»å‹™</h2>
                  <button @click="showForm = true" class="btn-primary">â• æ–°å¢ä»»å‹™</button>
                </div>

                <div v-if="tasks.length === 0" class="card text-center py-12">
                  <div class="text-6xl mb-4">ğŸ“</div>
                  <h3 class="text-xl font-bold text-gray-800 mb-2">æš«ç„¡ä»»å‹™</h3>
                  <p class="text-gray-600 mb-4">é–‹å§‹å‰µå»ºæ‚¨çš„ç¬¬ä¸€å€‹æ¶ç¥¨ä»»å‹™</p>
                  <button @click="showForm = true" class="btn-primary">å‰µå»ºä»»å‹™</button>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div v-for="task in tasks" :key="task.id"
                       class="card hover:shadow-lg transition cursor-pointer">
                    <div class="flex justify-between items-start mb-3">
                      <div>
                        <h3 class="font-bold text-gray-800">{{ task.eventName }}</h3>
                        <p class="text-sm text-gray-500">{{ task.name }}</p>
                      </div>
                      <span :class="['status-badge', statusClass(task.status)]">
                        {{ statusText(task.status) }}
                      </span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                      <div>ğŸ“… {{ task.eventDate }}</div>
                      <div>â° {{ task.startTime }}</div>
                      <div>ğŸ« {{ task.ticketQuantity }} å¼µ</div>
                    </div>
                    <div class="flex gap-2 pt-3 border-t">
                      <button v-if="task.status === 'pending'" 
                              @click="startTask(task.id)"
                              class="btn-sm bg-green-600 text-white hover:bg-green-700 flex-1">
                        â–¶ é–‹å§‹
                      </button>
                      <button v-if="task.status === 'running'" 
                              @click="pauseTask(task.id)"
                              class="btn-sm bg-yellow-600 text-white hover:bg-yellow-700 flex-1">
                        â¸ æš«åœ
                      </button>
                      <button @click="deleteTask(task.id)"
                              class="btn-sm bg-red-600 text-white hover:bg-red-700">
                        ğŸ—‘
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- çµ±è¨ˆ -->
              <div v-if="activeTab === 'çµ±è¨ˆ'">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">çµ±è¨ˆåˆ†æ</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                  <div class="card bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                    <div class="text-3xl mb-2">ğŸ“Š</div>
                    <div class="text-3xl font-bold">{{ stats.total }}</div>
                    <div class="text-sm opacity-90">ç¸½ä»»å‹™æ•¸</div>
                  </div>
                  <div class="card bg-gradient-to-br from-green-500 to-green-600 text-white">
                    <div class="text-3xl mb-2">âœ…</div>
                    <div class="text-3xl font-bold">{{ stats.success }}</div>
                    <div class="text-sm opacity-90">æˆåŠŸä»»å‹™</div>
                  </div>
                  <div class="card bg-gradient-to-br from-red-500 to-red-600 text-white">
                    <div class="text-3xl mb-2">âŒ</div>
                    <div class="text-3xl font-bold">{{ stats.failed }}</div>
                    <div class="text-sm opacity-90">å¤±æ•—ä»»å‹™</div>
                  </div>
                  <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                    <div class="text-3xl mb-2">ğŸ“ˆ</div>
                    <div class="text-3xl font-bold">{{ stats.rate }}%</div>
                    <div class="text-sm opacity-90">æˆåŠŸç‡</div>
                  </div>
                </div>
              </div>

              <!-- è¨­ç½® -->
              <div v-if="activeTab === 'è¨­ç½®'">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ç³»çµ±è¨­ç½®</h2>
                <div class="card space-y-4">
                  <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">æ¡Œé¢é€šçŸ¥</p>
                      <p class="text-sm text-gray-600">å…è¨±é¡¯ç¤ºæ¡Œé¢é€šçŸ¥</p>
                    </div>
                    <button @click="requestNotifPermission"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                      è«‹æ±‚æ¬Šé™
                    </button>
                  </div>
                  <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">ç³»çµ±ç‰ˆæœ¬</p>
                      <p class="text-sm text-gray-600">v0.4 - Stage 4</p>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">
                      121/121 æ¸¬è©¦é€šé âœ“
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </main>

          <!-- ä»»å‹™è¡¨å–®å½ˆçª— -->
          <div v-if="showForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold">å‰µå»ºæ–°ä»»å‹™</h2>
                  <button @click="closeForm" class="text-2xl text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <form @submit.prevent="saveTask" class="space-y-4">
                  <div>
                    <label class="block text-sm font-semibold mb-1">ä»»å‹™åç¨±</label>
                    <input v-model="form.name" type="text" required
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                  </div>
                  <div>
                    <label class="block text-sm font-semibold mb-1">æ´»å‹•åç¨±</label>
                    <input v-model="form.eventName" type="text" required
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-semibold mb-1">æ´»å‹•æ—¥æœŸ</label>
                      <input v-model="form.eventDate" type="date" required
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-semibold mb-1">é–‹æ¶æ™‚é–“</label>
                      <input v-model="form.startTime" type="datetime-local" required
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-semibold mb-1">è³¼è²·æ•¸é‡</label>
                      <input v-model.number="form.ticketQuantity" type="number" min="1" max="10" required
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                      <label class="block text-sm font-semibold mb-1">å„ªå…ˆç´š (1-10)</label>
                      <input v-model.number="form.priority" type="number" min="1" max="10"
                             class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-semibold mb-1">ç›®æ¨™ç¶²å€</label>
                    <input v-model="form.targetUrl" type="url"
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"
                           placeholder="https://ticketmaster.com/...">
                  </div>
                  <div class="flex gap-3 pt-4">
                    <button type="submit" class="btn-primary flex-1">å‰µå»ºä»»å‹™</button>
                    <button type="button" @click="closeForm" class="btn-secondary flex-1">å–æ¶ˆ</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      `,

      setup() {
        const loading = ref(true)
        const loggedIn = ref(false)
        const activeTab = ref('ä»»å‹™åˆ—è¡¨')
        const showForm = ref(false)
        const tasks = ref([])
        const notification = reactive({ show: false, type: 'success', message: '' })
        const form = reactive({
          name: '', eventName: '', eventDate: '', startTime: '',
          ticketQuantity: 1, priority: 5, targetUrl: '', clickSelector: '.buy-button'
        })

        const tabs = ['ä»»å‹™åˆ—è¡¨', 'çµ±è¨ˆ', 'è¨­ç½®']

        const stats = computed(() => {
          const total = tasks.value.length
          const success = tasks.value.filter(t => t.status === 'success').length
          const failed = tasks.value.filter(t => t.status === 'failed').length
          return { 
            total, 
            success, 
            failed, 
            rate: total > 0 ? Math.round((success / total) * 100) : 0 
          }
        })

        const notify = (msg, type = 'success') => {
          notification.show = true
          notification.type = type
          notification.message = msg
          setTimeout(() => notification.show = false, 3000)
        }

        const statusClass = (status) => {
          const map = {
            'pending': 'status-pending',
            'running': 'status-running',
            'success': 'status-success',
            'failed': 'status-failed',
            'paused': 'status-paused'
          }
          return map[status] || 'status-pending'
        }

        const statusText = (status) => {
          const map = {
            'pending': 'å¾…æ©Ÿ',
            'running': 'é‹è¡Œä¸­',
            'success': 'æˆåŠŸ',
            'failed': 'å¤±æ•—',
            'paused': 'å·²æš«åœ'
          }
          return map[status] || status
        }

        const loadTasks = async () => {
          tasks.value = await botEngine.listTasks()
        }

        const handleLogin = async () => {
          loading.value = true
          try {
            await loginAnonymous()
            loggedIn.value = true
            await loadTasks()
            notify('ç™»å…¥æˆåŠŸï¼')
          } catch (e) {
            notify(e.message, 'error')
          } finally {
            loading.value = false
          }
        }

        const handleLogout = async () => {
          await logout()
          loggedIn.value = false
          tasks.value = []
          notify('ç™»å‡ºæˆåŠŸ')
        }

        const saveTask = async () => {
          try {
            const task = createDefaultTask({
              name: form.name,
              eventName: form.eventName,
              eventDate: form.eventDate,
              startTime: form.startTime,
              ticketQuantity: form.ticketQuantity,
              priority: form.priority,
              config: {
                targetUrl: form.targetUrl,
                clickSelector: form.clickSelector,
                clickDelay: 500,
                retryCount: 3
              }
            })
            await botEngine.addTask(task)
            await loadTasks()
            closeForm()
            notify('ä»»å‹™å‰µå»ºæˆåŠŸï¼')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const startTask = async (id) => {
          try {
            await botEngine.startTask(id)
            await loadTasks()
            notify('ä»»å‹™å·²é–‹å§‹åŸ·è¡Œ')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const pauseTask = async (id) => {
          try {
            await botEngine.pauseTask(id)
            await loadTasks()
            notify('ä»»å‹™å·²æš«åœ')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const deleteTask = async (id) => {
          if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ')) return
          try {
            await botEngine.deleteTask(id)
            await loadTasks()
            notify('ä»»å‹™å·²åˆªé™¤')
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        const closeForm = () => {
          showForm.value = false
          Object.assign(form, {
            name: '', eventName: '', eventDate: '', startTime: '',
            ticketQuantity: 1, priority: 5, targetUrl: '', clickSelector: '.buy-button'
          })
        }

        const requestNotifPermission = async () => {
          try {
            const permission = await notificationSystem.requestPermission()
            if (permission === 'granted') {
              notify('é€šçŸ¥æ¬Šé™å·²å•Ÿç”¨ï¼')
            } else {
              notify('é€šçŸ¥æ¬Šé™è¢«æ‹’çµ•', 'error')
            }
          } catch (e) {
            notify(e.message, 'error')
          }
        }

        onMounted(async () => {
          try {
            await initGUN()
            const user = getCurrentUser()
            if (user) {
              loggedIn.value = true
              await loadTasks()
            }
          } catch (e) {
            console.error(e)
          } finally {
            loading.value = false
          }
        })

        return {
          loading, loggedIn, activeTab, showForm, tasks, notification, form, tabs, stats,
          handleLogin, handleLogout, saveTask, startTask, pauseTask, deleteTask, 
          closeForm, statusClass, statusText, requestNotifPermission
        }
      }
    })

    app.mount('#app')
  </script>
</body>
</html>
